<!DOCTYPE html >
<html>
  <head>
    <title>Croaker</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>   
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>   
    <script type="text/javascript" src="js/xml-to-json/jquery.xml2json.pack.js"></script>   
    <script type="text/javascript" src="js/underscore/underscore-min.js"></script>   
    <script type="text/javascript" src="js/croaker/croaker.js"></script>

    <script type="text/javascript">
      var App = (function () {
        var templateLoader = (function () {
          function load(name, key) {
            return $.get('templates/' + name, function (data) { $.template(key, data); }, 'html');
          }
          return { load: load };
        } ());

        var root = null;

        function loadXml(xmlPath) {
          return $.get(xmlPath, function (xml) { root = Croaker.parser.parse(xml); });
        }

        function loadTemplates() {
          return $.when(templateLoader.load('table-template.html', 'croaker-table'),
                        templateLoader.load('row-template.html', 'croaker-row'));
        }

        function display() {
          $('#main')
          .empty()
          .append($.tmpl('croaker-table', { defs: Croaker.metricDefs, rows: root.flat }));
        }

        function init(xmlPath) {
          $.when(loadXml(xmlPath), loadTemplates())
           .done(display);
        }
        return { init: init };
      } ());

      $(window).load(function () {
        App.init(window.location.search.substring(1).split('=')[1]);
      });
    </script>

  </head>
  <body>
    <div id="main">
    </div>
  </body>
</html>