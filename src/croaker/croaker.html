<!DOCTYPE html>
<html>
  <head>
    <title>Croaker</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>   
    <script type="text/javascript" src="js/lib/mustache.js"></script>   
    <script type="text/javascript" src="js/croaker.js"></script>

    <link rel="stylesheet" type="text/css" href="css/croaker.css" />
    <link rel="stylesheet" type="text/css" href="css/jquery-ui-1.8.19.custom.css" />
    
    <script id="metrics-template" type="text-x-mustache-tmpl">
      {{#getFullMetrics}}  
        <td>
          {{getFormattedValue}}
        </td>            
      {{/getFullMetrics}}
    </script>
    <script id="entry-template" type="text-x-mustache-tmpl">
      <tr>
        <td>
          {{strain}}
        </td>
        <td>
          {{name}}
        </td>
        {{> metrics}}
      </tr>       
    </script>    
    <script id="module-template" type="text-x-mustache-tmpl">
      <tr>
        <td>
          {{strain}}
        </td>
        <td>
          {{name}} -- {{version}}
        </td>
        {{> metrics}}
      </tr>       
      {{#namespaces}}
        {{> entry}}
        {{#types}}
          {{> entry}}
          {{#members}}
            {{> entry}}
          {{/members}}                  
        {{/types}}            
      {{/namespaces}}        
    </script>     
    <script id="main-template" type="text-x-mustache-tmpl">
      <table border="0" cellpadding="0" cellspacing="0"  id="table">
        <thead>
          <tr>
            <th>
              Type
            </th>
            <th>
              Name
            </th>
            {{#metricdefs}}
              <th>
                {{abbreviation}}
              </th>
            {{/metricdefs}}
            </th>
          </tr>
        </thead>          
        <tbody>
          {{#module}}
            {{> module}}
          {{/module}}
        </tbody>
      </table>
    </script>    

    <script type="text/javascript">
      function parseData(xml) {
        try {
        var nodes = new croaker.Parser().parse(xml),
          module = new croaker.Mapper().map(nodes),
          results = $('#results'),
          template = $('#main-template').html(),
          metricdefs = [croaker.defArray[0],croaker.defArray[1], croaker.defArray[2], croaker.defArray[3], croaker.defArray[4]];
          
          results.html(Mustache.to_html(template, {module:module, metricdefs: metricdefs}, 
                      {metrics: $('#metrics-template').html(), 
                       entry: $('#entry-template').html(),
                       module: $('#module-template').html()}));
        }   
        catch(e) {
          alert(e);
        }        
      }
      
      function load(e) {
        e.stopPropagation();
        e.preventDefault();
        //var url = new croaker.LocationUrlParser().parse();
        var url = $('#file').val();
        console.log('url: ', url);
        var loader = new croaker.DataLoader(url, parseData);
        loader
          .execute()
          .fail(function (jqxhr, status, error) {
            console.log('error');
            console.log(status);
            console.log(error);
          });      
      }

      function init() {
        $('#btnload').click(load);
      }

      $(window).load(init);
    </script>
  </head>
  <body >
    <div id="logo">
      <img src="logo.png"/>  
    </div>
    
    <div id="flash" class="ui-widget-content ui-state-highlight ui-corner-all">Doing work</div>    
    <br/>
    <div id="main">
     
      <div id="nav">
        <form>
          <label for="file">File</label>
          <input id="file" type="text" value="sample.xml"/>
          <button id="btnload">Load</button>
        </form>      
        </br>
        <form class="ui-corner-all">
          <label for="filter">Filter</label>
          <input id="filter" type="text" value=""/>
          <button id="filterBtn"> Filter </button>
        </form>
      </div>

      </br>
      <div id="results" class="ui-widget-content ui-corner-all"></div>
    </div>
  </body>
</html>