<!DOCTYPE Html>
<html>
  <head>
    <title>Croaker</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
    <script type="text/javascript" src="js/lib/mustache.js"></script>
    <script type="text/javascript" src="js/croaker.js"></script>

    <link rel="stylesheet" type="text/css" href="css/croaker.css" />
    <link rel="stylesheet" type="text/css" href="css/jquery-ui-1.8.19.custom.css" />
        
    <script id="metrics-template" type="text-x-mustache-tmpl">
      {{#getFullMetrics}}
        <td>
          {{getFormattedValue}}
        </td>
      {{/getFullMetrics}}
      
    </script>
    
    <script id="entry-template" type="text-x-mustache-tmpl">
      <tr>
        <td>
          {{strain}}
        </td>
        <td>
          {{name}}
        </td>
        {{> metrics}}
      </tr>
    </script>
        
    <script id="main-template" type="text-x-mustache-tmpl">
      <table border="0" cellpadding="0" cellspacing="0" id="table">
        <thead>
          <tr>
            <th>
              Type
            </th>
            <th>
              Name
            </th>
            {{#metricdefs}}
              <th>
                {{abbreviation}}
              </th>
            {{/metricdefs}}
            </th>
          </tr>
        </thead>
        <tbody>
          {{#listArray}}
            {{> entry}}
          {{/listArray}}
        </tbody>
      </table>
    </script>
    
    

    <script type="text/javascript">
      var filter,
        listArray,
        flash,
        mapper = new croaker.Mapper(),
        nsFilter = new croaker.StrainFilter('NS'),
        tyFilter = new croaker.StrainFilter('TY'),
        mbFilter = new croaker.StrainFilter('MB');
        
      function Flash() {
        var that = {};
        
        function displayMessage(message) {
          $('#flash').show()
          $('#flash').html(message);
        }
        
        that.displayMessage = displayMessage;
        
        return that;
      }
       
      function Filter() {
        var that = {}, list, strainFilters = [], nameFilters = [], 
          filters = [], 
          strainOrFilter, nameOrFilter;
        
        function setList(newList) {
          list = newList;
        }
        
        function setFilters() {
          if ($('#NS').is(':checked')) {
            strainFilters.push(nsFilter);
          }
        
          if ($('#TY').is(':checked')) {
            strainFilters.push(tyFilter);
          }
        
          if ($('#MB').is(':checked')) {
            strainFilters.push(mbFilter);
          }
        
          if ($('#filter').val().length > 0) {
            nameFilters.push(new croaker.NameFilter($('#filter').val()));
          }
          
          orFilter = new croaker.OrFilter(strainFilters);
          nameOrFilter = new croaker.OrFilter(nameFilters);
          
          filters = [orFilter, nameOrFilter];
          
          list.applyFilters(filters);
          
          strainFilters = [];
          nameFilters = [];
          
          return list.getAccepted();
        }
        
        function getList() {
          return list;
        }
        
        that.getList = getList;
        that.setFilters = setFilters;
        that.setList = setList;
        
        return that;
      }
      
      filter = new Filter();
      flash = new Flash()
          
      
      
      function parseData(xml) {
        flash.displayMessage('Parsing Data...');
        try {
          $('input').attr('disabled', true);
          $('input:checkbox').removeAttr('checked');
          $('#filter').val('');
          
          var nodes = new croaker.Parser().parse(xml),
            mappedNode = mapper.map(nodes),
            results = $('#results'),
            template = $('#main-template').html(),
            list = new croaker.FilteredList(mappedNode);

          filter.setList(list);
            
          listArray = filter.setFilters();
            
          results.html(Mustache.to_html(template, {listArray: listArray, metricdefs: croaker.allDefinitions },
                    {metrics: $('#metrics-template').html(),
                     entry: $('#entry-template').html()}));
            
          filter.getList().clearFilters();
          //$('#flash').hide();
          $('input').attr('disabled', false);
        }
        
        catch(e) {
          alert(e);
        }
      }

      function render(e) {
        e.stopPropagation();
        e.preventDefault();
        $('input').attr('disabled', true);
        flash.displayMessage('Filtering Data...');
        
        if (!listArray) {
          alert('XML is not loaded');
          return;
        }
        
        try {
          var results = $('#results'),
            template = $('#main-template').html();
         
          listArray = filter.setFilters();

          results.html(Mustache.to_html(template, {listArray: listArray, metricdefs: croaker.allDefinitions},
                      {metrics: $('#metrics-template').html(),
                       entry: $('#entry-template').html()}));
          
          filter.getList().clearFilters();
          
          $('input').attr('disabled', false);
        }
        
        catch(err) {
          alert(err);
        }
        $('#flash').hide();
      }

      function reset(e) {
        e.stopPropagation();
        e.preventDefault();
        
        $('input:checkbox').removeAttr('checked');
        $('#filter').val('');
        
      }

      function load(e) {
        
        e.stopPropagation();
        e.preventDefault();
               
        //var url = new croaker.LocationUrlParser().parse();
        var url = $('#file').val();
        var loader = new croaker.DataLoader(url, parseData);
        loader
          .execute()
          .fail(function (jqxhr, status, error) {
            alert('error');
            alert(status);
            alert(error);
          });
      }
      
      function highlight() {
        $(this).toggleClass('highlighted');
      }

      function init() {
        $('#btnload').click(load);
        $('#filterBtn').click(render);
        $('#resetBtn').click(reset);    
        $('#results').on('click', 'tbody > tr', highlight);
      }

      $(window).load(init);
      
    </script>
  </head>
  <body >
    <div id="heading">
      Croaker
    </div>

    <div id="flash" class="ui-widget-content ui-state-highlight ui-corner-all"></div>
    <br/>
    <br/>
    <div id="main">

      <div id="nav">
        <form>
          <label for="file"></label>
          <input id="file" type="text" value="test.xml"/>
          <button id="btnload">Load</button>
        </form>
        </br>
        <form class="ui-corner-all">
          <input id="filter" type="text" value=""/>
           NS
          <input type="checkbox" id="NS"/>
          TY
          <input type="checkbox" id="TY"/>
          MB
          <input type="checkbox" id="MB"/>
          
          <button id="filterBtn"> Filter </button>
          <button id="resetBtn"> Reset </button>
          
        </form>
        </br>
        
      </div>

      </br>
      <div id="results" class="ui-widget-content ui-corner-all"></div>
    </div>
  </body>
</html>