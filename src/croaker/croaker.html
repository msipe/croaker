<!DOCTYPE html >
<html>
  <head>
    <title>Croaker</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>   
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>   
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>   
    <script type="text/javascript" src="js/xml-to-json/jquery.xml2json.pack.js"></script>   
    <script type="text/javascript" src="js/underscore/underscore-min.js"></script>   
    <script type="text/javascript" src="js/croaker/croaker.js"></script>

    <link rel="stylesheet" type="text/css" href="css/theme/redmond/jquery-ui-1.8.16.custom.css" />
    <link rel="stylesheet" type="text/css" href="css/croaker/croaker.css" />

    <script type="text/javascript">
      var App = (function () {
        var flash = (function () {
          function hide() {
            $('#flash').slideUp();
          }

          function set(msg) {
            return $('#flash').text(msg).slideDown();
          }

          return { set: set, hide: hide };
        } ());

        var templateLoader = (function () {
          function loadTemplate(name, key) {
            return $.get('templates/' + name, function (data) { $.template(key, data); }, 'html');
          }

          function load() {
            return $.when(loadTemplate('table-template.html', 'croaker-table'),
                          loadTemplate('row-template.html', 'croaker-row'));
          }

          return { load: load };
        } ());

        var resultTable = (function () {
          function display(data) {
            $('#results')
              .hide()
              .empty()
              .append($.tmpl('croaker-table', { defs: Croaker.metricDefs, rows: data }))
              .find('th')
              .addClass('ui-state-default')
              .end()
              .find('td')
              .addClass('ui-widget-content')
              .end()
              .find('tr')
              .hover(function () { $(this).children('td').addClass('ui-state-hover').css('font-weight', 'normal'); },
                     function () { $(this).children('td').removeClass('ui-state-hover'); })
              .click(function () { $(this).children('td').toggleClass('ui-state-highlight'); })
              .end()
              .show();
          }

          return { display: display };
        } ());


        var root = null;
        var xmlPath = null;

        function loadXml() {
          return $.get(xmlPath, function (xml) { root = Croaker.parser.parse(xml); });
        }

        function display() {
          resultTable.display(root.flat);
          $('#nav').show();
          flash.hide();
        }

        function beginLoading() {
          $.when(loadXml(xmlPath), templateLoader.load()).done(display);
        }

        function getXmlPath() {
          return window.location.search.substring(1).split('=')[1];
        }

        function doSearch() {
          $.when(flash.set('Searching...'))
            .done(function () {
              resultTable.display(root.search.execute($('#search').val(), true));
              flash.hide();
            });
          return false;
        }

        function init() {
          $('#main')
            .delegate('#btnsearch', { click: doSearch });

          xmlPath = getXmlPath();
          if (xmlPath) {
            $.when(flash.set('Loading File...')).done(beginLoading);
          } else {
            flash.set('Invalid or missing file');
          }
        }
        return { init: init };
      } ());

      $(window).load(function () {
        App.init();
      });
    </script>

  </head>
  <body>
    <div id="main">
      <div id="flash" class="ui-widget-content ui-state-highlight ui-corner-all" style="display:none"></div>
      <div id="nav" class="ui-widget-content ui-corner-all" style="display:none">
        <form>
          <label for="search">Search</label>
          <input id="search" type="text" />
          <button id="btnsearch" class="ui-state-default ui-corner-all">Search</button>
        </form>
      </div>
      <div id="results" class="ui-widget-content ui-corner-all" style="display:none"></div>
    </div>
  </body>
</html>