<!DOCTYPE html >
<html>
  <head>
    <title>Croaker</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>   
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>   
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>   
    <script type="text/javascript" src="js/xml-to-json/jquery.xml2json.pack.js"></script>   
    <script type="text/javascript" src="js/underscore/underscore-min.js"></script>   
    <script type="text/javascript" src="js/croaker/croaker.js"></script>

    <link rel="stylesheet" type="text/css" href="css/theme/redmond/jquery-ui-1.8.16.custom.css" />
    <link rel="stylesheet" type="text/css" href="css/croaker/croaker.css" />

    <script type="text/javascript">
      var App = (function () {
        var flash = (function () {
          function hide() {
            $('#flash').slideUp();
          }

          function set(msg) {
            return $('#flash').text(msg).slideDown();
          }

          return { set: set, hide: hide };
        } ());

        var templateLoader = (function () {
          function load(name, key) {
            return $.get('templates/' + name, function (data) { $.template(key, data); }, 'html');
          }
          return { load: load };
        } ());

        var resultTable = (function () {
          var $table = null;

          function init() {
            $table = $('#main table');
            $table
              .find('th')
              .addClass('ui-state-default')
              .end()
              .find('td')
              .addClass('ui-widget-content')
              .end()
              .find('tr')
              .hover(function () { $(this).children('td').addClass('ui-state-hover'); },
                     function () { $(this).children('td').removeClass('ui-state-hover'); })
              .click(function () { $(this).children('td').toggleClass('ui-state-highlight'); });
          }

          return { init: init };
        } ());


        var root = null;
        var xmlPath = null;

        function loadXml() {
          return $.get(xmlPath, function (xml) { root = Croaker.parser.parse(xml); });
        }

        function loadTemplates() {
          return $.when(templateLoader.load('table-template.html', 'croaker-table'),
                        templateLoader.load('row-template.html', 'croaker-row'));
        }

        function display() {
          $('#main')
          .empty()
          .append($.tmpl('croaker-table', { defs: Croaker.metricDefs, rows: root.flat }));

          resultTable.init();
          flash.hide();
        }

        function beginLoading() {
          $.when(loadXml(xmlPath), loadTemplates()).done(display);
        }

        function getXmlPath() {
          return window.location.search.substring(1).split('=')[1];
        }

        function init() {
          xmlPath = getXmlPath();
          if (xmlPath) {
            $.when(flash.set('Loading File...')).done(beginLoading);
          } else {
            flash.set('Invalid or missing file');
          }
        }
        return { init: init };
      } ());

      $(window).load(function () {
        App.init();
      });
    </script>

  </head>
  <body>
    <div class="ui-state-highlight ui-corner-all" id="flash"></div>
    <div class="ui-widget" id="main"></div>
  </body>
</html>